/*!
 * Gensee EasyCast JavaScript SDK
 * http://www.gensee.com/
 * Date: 2013-1-29
 */
var app=getApp();var SDK=(function(){var that={};that.defaultKey="_GS_SDK_default_group_"+(new Date()).getTime();that.suites={};that.widgets={};that.N=0;that.register=function(ns,maker){var NSList=ns.split(".");var step=that;var k=null;while(k=NSList.shift()){if(NSList.length){if(step[k]===undefined){step[k]={}}step=step[k]}else{if(step[k]===undefined){step[k]=maker(that)}}}};that.trim=function(str){if(typeof str!=="string"){return str}if(typeof str.trim==="function"){return str.trim()}else{return str.replace(/^(\u3000|\s|\t|\u00A0)*|(\u3000|\s|\t|\u00A0)*$/g,"")}};that.isEmpty=function(obj){if(obj===undefined){return true}else{if(obj==null){return true}else{if(typeof obj==="string"){if(that.trim(obj)==""){return true}}}}return false};that.isNotEmpty=function(obj){return !that.isEmpty(obj)};that.Event=(function(type,target,data,callback,receiver){this.type=type;this.target=target;this.data=data;if(typeof callback=="string"){this.receiver=callback}else{this.cb=callback;this.receiver=receiver}});that.Logger=(function(name){var _logger=this;this.name=name;this.logs=[];var levels={"DEBUG":0,"INFO":1,"WARN":2,"ERROR":3,"FATAL":4};this.level="INFO";this.out=function(log){_logger.logs.push(log)};this.log=function(msg,type,data){type=type?type:"info";var grade=levels[type.toUpperCase()];var outGrade=levels[_logger.level.toUpperCase()];if(typeof grade==="number"&&typeof outGrade==="number"){if(grade<outGrade){return}}if(typeof msg!=="string"){this.log("log(msg, type), type of msg must be 'string'","ERROR",msg);return}};this.moveLogs=function(n){return _logger.logs.splice(0,n||_logger.logs.length)}});that.logger=new that.Logger();that.log=that.logger.log;that.asyncRun=function(fun,param){setTimeout(function(){try{fun(param)}catch(e){that.log(""+e,"ERROR",e);throw e}},0)};that.register("core.util.assignProperties",function(){return function(oSource,oProperties,keyHandler,valueHandler){if(typeof oProperties!="undefined"){for(var key in oProperties){var value=oProperties[key];if(typeof keyHandler==="function"){key=keyHandler(key)}if(typeof valueHandler==="function"){value=valueHandler(value)}oSource[key]=value}}return oSource}});var Widget=(function(){var W=function(orign,type,options){this.enabled=true;this.orign=orign;this.type=type;this.elem=options?options.elem:{};this.attrs=options?options.attrs:null;this.initId()};W.fn=W.prototype={constructor:W,attr:function(name){if(that.isNotEmpty(this.attrs)){return this.attrs[name]}var value="";try{if(this.elem.getAttribute){value=this.elem.getAttribute(name);value=that.trim(value)}}catch(e){that.log(".getAttribute(name) throw:"+e,"ERROR",this)}return that.isEmpty(value)?"":value},initId:function(){var id=this.attr("id");if(that.isEmpty(id)){id="_GS_WIDGET_"+that.N++;id+="_"+(new Date()).getTime()}this.id=id},bind:function(type,handler){if(!this.enabled){return}type=type.toLowerCase();if(!this.suite.eventsmap[type]){this.suite.eventsmap[type]=[]}this.suite.eventsmap[type].push({wgid:this.id,handler:handler})},unbind:function(type,handler){if(!this.enabled){return}type=type.toLowerCase();var handlers=this.suite.eventsmap[type];if(handlers){for(var i=0;i<handlers.length;i++){if(handlers[i]["handler"]==handler){handlers.splice(i,1);break}}}},fire:function(event){if(!this.enabled){return}if(!(event instanceof that.Event)){that.log("It's not instanceof Event - "+event,"ERROR");throw"[SDK]ERROR! It's not a instance of Event - "+event}if(event.type=="onRewardResponse"&&event.data&&event.data.userControl!=undefined&&event.data.userControl=="false"&&event.data.returnCode=="0"){window.top.location.href=event.data.codeUrl;return}var type=event.type.toLowerCase();var handlers=this.suite.eventsmap[type];var len=0;if(handlers){len=handlers.length;var receiver=event.receiver;for(var i=0;i<handlers.length;i++){if(!receiver){that.asyncRun(handlers[i]["handler"],event)}else{if(receiver==handlers[i]["wgid"]){that.asyncRun(handlers[i]["handler"],event)}}}}that.log("send message of '"+event.type+"'","DEBUG",event);return len},};return W})();var Suite=(function(){var S=function(key){if(that.isEmpty(key)){key=that.defaultKey}this.key=key;this.init()};S.fn=S.prototype={constructor:S,init:function(){this.eventsmap={};this.widgets={}},loadWidget:function(widget){if(typeof widget.id===undefined){throw new ERROR("widget's id is undefined. "+widget)}if(this.widgets[widget.id]===undefined){widget.suite=this;this.widgets[widget.id]=widget;that.widgets[widget.id]=widget;that.log("Widget("+widget.id+") has loaded!","INFO",widget)}},createWidget:function(orign,type,options){type=type.toLowerCase();var widget=new Widget(orign,type,options);this.loadWidget(widget);return widget},clearWidget:function(id){this.eventsmap={};this.widgets={};that.suites={};that.widgets={}},removeWidget:function(widgetId){if(typeof widgetId===undefined){throw new ERROR("widgetId is undefined.")}var widget=this.widgets[widgetId];if(that.isEmpty(widget)){throw new ERROR("widget not found in suite for widgetId:"+widgetId)}widget.suite=null;for(var item in this.eventsmap){var handlers=this.eventsmap[item];if(handlers){for(var i=0;i<handlers.length;i++){if(handlers[i]["wgid"]==widgetId){handlers.splice(i,1);break}}}}delete this.widgets[widgetId];delete that.widgets[widgetId];that.log("Widget("+widgetId+") has remove!","INFO",widgetId);return widget}};return S})();that.suite=function(key){if(that.isEmpty(key)){key=that.defaultKey}var suite=that.suites[key];if(typeof suite=="undefined"){suite=new Suite(key);that.suites[key]=suite}return suite};return that})();SDK.logger.name="SDK";SDK.register("api.ready",function(){return function(callback){SDK.core.dom.ready(callback)}});SDK.register("api.widget",function(){return function(id){return SDK.widgets[id]}});SDK.register("api.widget.proxy",function(that){return function(id){var widget=that.api.widget(id);if(that.isEmpty(widget)){that.log("No widget which id is "+id,"ERROR");throw"[SDK]ERROR! no widget which id is "+id}if(widget.proxy===undefined){var proxy=widget.proxy={id:id,type:widget.type,group:widget.suite.key,enabled:true};widget.eventTargetProxy={id:id,type:widget.type};proxy.extend=function(obj){that.core.util.assignProperties(proxy,obj)};proxy.bind=function(type,handler){if(!proxy.enabled){return}if(typeof type!=="string"){that.log("Type of event must be a string!","ERROR");return}if(typeof handler!=="function"){that.log("Handler of event must be a function!","ERROR");return}type=that.trim(type);if(that.isEmpty(type)){that.log("Empty type of event is invalid!","ERROR");return}widget.bind(type,handler)};proxy.unbind=function(type,handler){if(!proxy.enabled){return}if(typeof type!=="string"){that.log("Type of event must be a string!","ERROR");return}if(typeof handler!=="function"){that.log("Handler of event must be a function!","ERROR");return}type=that.trim(type);if(that.isEmpty(type)){that.log("Empty type of event is invalid!","ERROR");return}widget.unbind(type,handler)};proxy.send=function(type,data,cb,receiver){if(!proxy.enabled){return}if(typeof cb=="string"){receiver=cb;cb=undefined}if(typeof type!=="string"){that.log("Type of message must be a string!","ERROR");throw"[SDK]ERROR! Type of message must be a string!"}type=that.trim(type);type=typeCenter.types(type);var event=new that.Event(type,widget.eventTargetProxy,data,cb,receiver);var len=widget.fire(event);if(len==0){var pre=widget.suite.key==that.defaultKey?"":widget.suite.key+".";that.log("No handler had bound to '"+pre+event.type+"'!","WARN",event)}return len};proxy.activeShakehand=function(shakeFn,dataInMyHand,withType){if(!proxy.enabled){return}widget._dataInMyHand=dataInMyHand;if(typeof withType==="string"&&that.isNotEmpty(withType)){widget._shakeWithType=withType}else{delete widget._shakeWithType}if(typeof shakeFn=="function"){proxy.shakehand=function(wg){setTimeout(function(){shakeFn(wg._dataInMyHand)},0)}}else{proxy.shakehand=function(){}}var suite=widget.suite;if(suite){for(var id in suite.widgets){var _widget=suite.widgets[id];if(_widget.id==widget.id){continue}var _proxy=that.api.widget.proxy(_widget.id);if(that.isNotEmpty(_proxy.shakehand)){var b1=true;if(widget._shakeWithType&&widget._shakeWithType!=_widget.type){b1=false}var b2=true;if(_widget._shakeWithType&&_widget._shakeWithType!=widget.type){b2=false}if(b1&&b2){proxy.shakehand(_widget);_proxy.shakehand(widget)}}}}}}return widget.proxy}});var typeCenter=(function(){var C={};var typeMapping={};C.types=function(arg){if(typeof arg==="object"){SDK.core.util.assignProperties(typeMapping,arg,function(key){return SDK.trim(key).toLowerCase()})}else{if(typeof arg==="string"){var msgType=arg.toLowerCase();return typeMapping[msgType]?typeMapping[msgType]:arg}else{if(SDK.isEmpty(arg)){return typeMapping}else{SDK.log("typeCenter.types(arg):arg not support-"+arg,"WARN")}}}};return C})();var GS={version:"1.0",autoload:false,init:function(options){SDK.log("[SDK]init","INFO",options)},createChannel:function(group){var widget=SDK.suite(group).createWidget("CHANNEL","CHANNEL");return SDK.api.widget.proxy(widget.id)},removeChannel:function(id,group){SDK.suite(group).removeWidget(id)},clearChannel:function(){SDK.suite().clearWidget()}};var tool={};tool.checkObjectIsNull=function(obj){return(obj==null||obj==undefined||typeof(obj)=="undefined")?true:false};tool.checkObjectIsNotNull=function(obj){return !this.checkObjectIsNull(obj)};tool.isFunction=function(obj){return(typeof(obj)=="function")?true:false};tool.checkParamsIsNotNull=function(str,obj){if(this.checkObjectIsNotNull(str)){var splitArray=str.split(".");var objSplit="";for(var i=0;i<splitArray.length;i++){if(i!=0){objSplit+=".";objSplit+=splitArray[i]}else{objSplit="obj"}if(eval("typeof("+objSplit+")=='undefined'")){return false}}return true}return false};tool.extend=function(){var options,name,src,copy,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(typeof target!=="object"&&!this.isFunction(target)){target={}
}if(length===i){target=this;--i}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(copy!==undefined){target[name]=copy}}}}return target};tool.trim=function(str){if(typeof str!=="string"){return str}if(typeof str.trim==="function"){return str.trim()}else{return str.replace(/^(\u3000|\s|\t|\u00A0)*|(\u3000|\s|\t|\u00A0)*$/g,"")}};tool.isEmptyObject=function(obj){for(var name in obj){return false}return true};tool.isEmpty=function(obj){if(obj===undefined){return true}else{if(obj==null){return true}else{if(typeof obj==="string"){if(tool.trim(obj)==""){return true}}}}return false};tool.decodeHex=function(data){if(data.length%2){return""}var tmp="";for(var i=0;i<data.length;i+=2){tmp+="%"+data.charAt(i)+data.charAt(i+1)}return decodeURIComponent(tmp)};tool.createUUID=function(){var dg=new Date(1582,10,15,0,0,0,0);var dc=new Date();var t=dc.getTime()-dg.getTime();var h="-";var tl=tool.getIntegerBits(t,0,31);var tm=tool.getIntegerBits(t,32,47);var thv=tool.getIntegerBits(t,48,59)+"1";var csar=tool.getIntegerBits(tool.rand(4095),0,7);var csl=tool.getIntegerBits(tool.rand(4095),0,7);var n=tool.getIntegerBits(tool.rand(8191),0,7)+tool.getIntegerBits(tool.rand(8191),8,15)+tool.getIntegerBits(tool.rand(8191),0,7)+tool.getIntegerBits(tool.rand(8191),8,15)+tool.getIntegerBits(tool.rand(8191),0,15);return tl+h+tm+h+thv+h+csar+csl+h+n};tool.getIntegerBits=function(val,start,end){var base16=tool.returnBase(val,16);var quadArray=new Array();var quadString="";var i=0;for(i=0;i<base16.length;i++){quadArray.push(base16.substring(i,i+1))}for(i=Math.floor(start/4);i<=Math.floor(end/4);i++){if(!quadArray[i]||quadArray[i]==""){quadString+="0"}else{quadString+=quadArray[i]}}return quadString};tool.returnBase=function(number,base){var convert=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];if(number<base){var output=convert[number]}else{var MSD=""+Math.floor(number/base);var LSD=number-MSD*base;if(MSD>=base){var output=this.returnBase(MSD,base)+convert[LSD]}else{var output=convert[MSD]+convert[LSD]}}return output};tool.rand=function(max){return Math.floor(Math.random()*max)};tool.isArray=function(obj){if(typeof obj==="object"){return Object.prototype.toString.call(obj)==="[object Array]"}return false};tool.createXml=function(root,encoding){if(tool.isEmpty(encoding)){encoding=""}else{encoding='encoding="'+encoding+'"'}var xmlDoc='<?xml version="1.0" '+encoding+"?>";if(!tool.isEmpty(root)){xmlDoc+=tool.createNode(root)}return xmlDoc};tool.createNode=function(obj,isCdata){if(tool.isEmpty(isCdata)){isCdata=true}if(tool.isEmpty(obj)){return}if(tool.isEmpty(obj.nodeName)){return}var node="<"+obj.nodeName;if(!this.isEmpty(obj.attrArray)){for(var i=0;i<obj.attrArray.length;i++){var attr=obj.attrArray[i];node+=" "+attr.name+'="'+attr.value+'"'}}var node=node+">";if(!tool.isEmpty(obj.value)){if(isCdata){node=node+"<![CDATA["+obj.value+"]]>"}else{node=node+obj.value}}var node=node+"</"+obj.nodeName+">";return node};tool.createNodeNone=function(obj){if(tool.isEmpty(obj)){return}if(tool.isEmpty(obj.nodeName)){return}var node="<"+obj.nodeName;if(!tool.isEmpty(obj.attrArray)){for(var i=0;i<obj.attrArray.length;i++){var attr=obj.attrArray[i];node+=" "+attr.name+'="'+attr.value+'"'}}var node=node+"/>";return node};tool.createNodeText=function(obj,isCdata){if(tool.isEmpty(isCdata)){isCdata=true}if(tool.isEmpty(obj)){return}if(tool.isEmpty(obj.nodeName)){return}var node="<"+obj.nodeName;if(!tool.isEmpty(obj.attrArray)){for(var i=0;i<obj.attrArray.length;i++){var attr=obj.attrArray[i];node+=" "+attr.name+'="'+attr.value+'"'}}var node=node+">";if(!tool.isEmpty(obj.value)){if(isCdata){node=node+"<![CDATA["+obj.value+"]]>"}else{node=node+obj.value}}if(!tool.isEmpty(obj.textArray)){if(obj.textArray.length>0){for(var i=0;i<obj.textArray.length;i++){var textObj=obj.textArray[i];if(!tool.isEmpty(textObj.nodeName)){node=node+"<"+textObj.nodeName+"><![CDATA[";if(!tool.isEmpty(textObj.value)){node=node+textObj.value}node=node+"]]>"+"</"+textObj.nodeName+">"}}}}var node=node+"</"+obj.nodeName+">";return node};tool.addNode=function(parent,child,tag,indexof){var result=0;if(!tool.isEmpty(tag)){if(tool.isEmpty(indexof)){indexof=1}var cloneStr=parent;var startIndex=0;for(var i=0;i<indexof;i++){startIndex=cloneStr.indexOf(tag,startIndex);if(startIndex==-1){return}var tempIndex=cloneStr.lastIndexOf("<",startIndex);var tempEndTag=cloneStr.lastIndexOf("</",startIndex);if(tempIndex<=tempEndTag){i--}startIndex=startIndex+tag.length}if(startIndex==0){return}cloneStr=cloneStr.substring(startIndex+tag.length);result+=startIndex+tag.length;startIndex=0;var s=0;var con=true;while(con){startIndex=cloneStr.indexOf(tag);if(startIndex==-1){return}var tempIndex=cloneStr.lastIndexOf("<",startIndex);var tempEndTag=cloneStr.lastIndexOf("</",startIndex);if(tempIndex<=tempEndTag){s--}else{s++}if(s<0){result+=tempEndTag;con=false}}}else{var cloneStr=parent;result=cloneStr.lastIndexOf("</");if(result==-1){return}}return parent.substring(0,result)+child+parent.substring(result)};tool.formatXml=function(xml){var xmlDoc;var parser=new DOMParser();xmlDoc=parser.parseFromString(xml,"application/xml");return xmlDoc};tool.parseXml=function(xml){var xmlDoc;var XMLParser=new DOMParser;xmlDoc=XMLParser.parseFromString(xml);xml=xmlDoc;return xml};tool.getXmlNodeAttr=function(node,attrName){if(!node){return""}if(!node.attributes){return""}if(node.attributes[attrName]!=null){return node.attributes[attrName].value}if(node.attributes.getNamedItem(attrName)!=null){return node.attributes.getNamedItem(attrName).value}return""};tool.getNodeValue=function(node){var textContent=tool.trim(node.textContent);return textContent};tool.logger=(function(name){var _logger=this;this.name=name;this.logs=[];var levels={"DEBUG":0,"INFO":1,"WARN":2,"ERROR":3,"FATAL":4};this.level="INFO";this.out=function(log){_logger.logs.push(log);console.log(log)};this.log=function(msg,type,data){type=type?type:"info";var grade=levels[type.toUpperCase()];var outGrade=levels[_logger.level.toUpperCase()];if(typeof grade==="number"&&typeof outGrade==="number"){if(grade<outGrade){return}}if(typeof msg!=="string"){this.log("log(msg, type), type of msg must be 'string'","ERROR",msg);return}_logger.out({time:new Date(),msg:msg,type:type,data:data})};this.moveLogs=function(n){return _logger.logs.splice(0,n||_logger.logs.length)}});tool.isBlank=function(obj){if(this.isEmpty(obj)||this.trim(obj)==""){return true}else{return false}};tool.ajax=function(options){wx.request({url:options.url,header:options.header,method:options.type,responseType:options.responseType,dataType:options.dataType,data:options.data,success:options.success,fail:options.error})};tool.isNumber=function(obj){if(this.isEmpty(obj)){return false}var reg=/^([0-9]|[1-9][0-9]*|[0-9]\.[0-9]+|[1-9][0-9]*\.[0-9]+)$/;var result=reg.test(obj);return result};var hTasks=[];var task=function(opt){hTasks=opt.hTasks;var that=this;this.executedImmediately=opt.executedImmediately!=undefined?opt.executedImmediately:false;this.taskArray=new Array();this.taskFunction=new Array();this.defaultOpt={interval:200,status:false};this.anyOpt={interval:200,status:false};this.timeOutObj=null;this.anyOutObj=null;this.dealTask=false;this.i=0;this.timeOut=function(){that.dealTask=true;var taskArray=that.taskArray;var taskFunction=that.taskFunction;var initupdateTime=100000;if(taskArray.length>0){var updateTime=app.globalData.currentTime*1000;if(updateTime>=0){for(var i=0;i<taskArray.length;i++){var task=taskArray[i];if(task.startTime==null||task.startTime==undefined||typeof(task.startTime)=="undefined"||task.startTime==""){var taskType=task.type;for(var j=0;j<taskFunction.length;j++){var taskFun=taskFunction[j];if(taskFun.type==taskType){taskFun.startFun.call(this,task.data);break}}taskArray.splice(i,1);i--}else{if(task.startTime<=updateTime){if(task.endTime==null||task.endTime==undefined||typeof(task.endTime)=="undefined"||task.endTime==""){var taskType=task.type;for(var j=0;j<taskFunction.length;j++){var taskFun=taskFunction[j];if(taskFun.type==taskType){taskFun.startFun.call(this,task.data);break}}taskArray.splice(i,1);i--}else{if(updateTime<task.endTime){var taskType=task.type;if(task.startDeal==null||task.startDeal==undefined||typeof(task.startDeal)=="undefined"){for(var j=0;j<taskFunction.length;j++){var taskFun=taskFunction[j];if(taskFun.type==taskType){task.startDeal=true;taskFun.startFun.call(this,task.data);break}}}}else{var taskType=task.type;for(var j=0;j<taskFunction.length;j++){var taskFun=taskFunction[j];if(taskFun.type==taskType){taskFun.endFun.call(this,task.data);break}}taskArray.splice(i,1);i--}}}}}}}that.dealTask=false};this.anyTimeOut=function(){var taskArray=that.taskArray;var taskFunction=that.taskFunction;if(taskArray.length>0){for(var i=0;i<taskArray.length;i++){var task=taskArray[i];if(task.type=="ems"&&(task.data.dealFunction=="onPriChat"||task.data.dealFunction=="onChatRemove"||task.data.dealFunction=="onPublicChat"||task.data.dealFunction=="onThirdPartChat"||(task.data.dealFunction=="onSetting"&&task.data.content.option=="chat"))){var taskType=task.type;for(var j=0;j<taskFunction.length;j++){var taskFun=taskFunction[j];if(taskFun.type==taskType){taskFun.startFun.call(this,task.data);break}}taskArray.splice(i,1);i--}}}}};task.prototype.switchMedia=function(meida){this.media=media};task.prototype.setInterval=function(intervalTime){var that=this;if(!this.dealTask){this.defaultOpt.interval=intervalTime;if(this.defaultOpt.status){clearInterval(this.timeOutObj);this.timeOutObj=setInterval(function(){that.timeOut()},this.defaultOpt.interval)}return true}return false};task.prototype.start=function(){var that=this;if(this.anyOutObj!=null){clearInterval(this.anyOutObj)}if(!this.defaultOpt.status){this.timeOutObj=setInterval(function(){that.timeOut()},this.defaultOpt.interval);this.defaultOpt.status=true}};task.prototype.stop=function(){if(!this.dealTask){clearInterval(this.timeOutObj);
this.defaultOpt.status=false;return true}else{return false}};task.prototype.anyStart=function(){var that=this;if(!this.anyOpt.status){this.anyOutObj=setInterval(function(){that.anyTimeOut()},this.anyOpt.interval);this.anyOpt.status=true}};task.prototype.addTaskFunction=function(type,startFun,endFun){var taskFunction=this.taskFunction;if(tool.checkObjectIsNull(type)){return false}if(!tool.isFunction(startFun)){return false}var taskFun={type:type,startFun:startFun};if(!tool.isFunction(endFun)){taskFun.endFun=function(){}}else{taskFun.endFun=endFun}taskFunction.push(taskFun);return true};task.prototype.addTask=function(type,data,startTime,endTime){var taskArray=this.taskArray;if(tool.checkObjectIsNull(type)){return false}var task={};if(data.taskId){if(compareHisTask(type+data.taskId)){return}else{loadHisTask(type+data.taskId)}}if(this.executedImmediately){task={type:type,data:data,startTime:null,endTime:null}}else{task={type:type,data:data,startTime:startTime,endTime:endTime}}taskArray.push(task);return true};task.prototype.clearTask=function(){var taskArray=this.taskArray;taskArray.splice(0,taskArray.length)};task.prototype.executeAllTask=function(){var taskArray=this.taskArray;console.log("[executeAllTask]:"+taskArray.length);for(var i=0;i<taskArray.length;i++){var task=taskArray[i];task.startTime=null;task.endTime=null}};function loadHisTask(taskId){var obj={};obj.taskId=taskId;obj.time=new Date().getTime();hTasks.push(obj)}function compareHisTask(taskId){for(var i=0;i<hTasks.length;i++){var data=hTasks[i];if(taskId==data.taskId){return true}}return false}var nameStartChar=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,nameChar=new RegExp("[\\-\\.0-9"+nameStartChar.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),tagNamePattern=new RegExp("^"+nameStartChar.source+nameChar.source+"*(?::"+nameStartChar.source+nameChar.source+"*)?$"),S_TAG=0,S_ATTR=1,S_ATTR_SPACE=2,S_EQ=3,S_ATTR_NOQUOT_VALUE=4,S_ATTR_END=5,S_TAG_SPACE=6,S_TAG_CLOSE=7;function XMLReader(){}function parse(source,defaultNSMapCopy,entityMap,domBuilder,errorHandler){function entityReplacer(a){var k=a.slice(1,-1);return k in entityMap?entityMap[k]:"#"===k.charAt(0)?function(code){if(code>65535){var surrogate1=55296+((code-=65536)>>10),surrogate2=56320+(1023&code);return String.fromCharCode(surrogate1,surrogate2)}return String.fromCharCode(code)}(parseInt(k.substr(1).replace("x","0x"))):(errorHandler.error("entity not found:"+a),a)}function appendText(end){if(end>start){var xt=source.substring(start,end).replace(/&#?\w+;/g,entityReplacer);locator&&position(start),domBuilder.characters(xt,0,end-start),start=end}}function position(p,m){for(;p>=lineEnd&&(m=linePattern.exec(source));){lineStart=m.index,lineEnd=lineStart+m[0].length,locator.lineNumber++}locator.columnNumber=p-lineStart+1}for(var lineStart=0,lineEnd=0,linePattern=/.*(?:\r\n?|\n)|.*$/g,locator=domBuilder.locator,parseStack=[{currentNSMap:defaultNSMapCopy}],closeMap={},start=0;;){try{var tagStart=source.indexOf("<",start);if(tagStart<0){if(!source.substr(start).match(/^\s*$/)){var doc=domBuilder.doc,text=doc.createTextNode(source.substr(start));doc.appendChild(text),domBuilder.currentElement=text}return}switch(tagStart>start&&appendText(tagStart),source.charAt(tagStart+1)){case"/":var end=source.indexOf(">",tagStart+3),tagName=source.substring(tagStart+2,end),config=parseStack.pop();end<0?(tagName=source.substring(tagStart+2).replace(/[\s<].*/,""),errorHandler.error("end tag name: "+tagName+" is not complete:"+config.tagName),end=tagStart+1+tagName.length):tagName.match(/\s</)&&(tagName=tagName.replace(/[\s<].*/,""),errorHandler.error("end tag name: "+tagName+" maybe not complete"),end=tagStart+1+tagName.length);var localNSMap=config.localNSMap,endMatch=config.tagName==tagName;if(endMatch||config.tagName&&config.tagName.toLowerCase()==tagName.toLowerCase()){if(domBuilder.endElement(config.uri,config.localName,tagName),localNSMap){for(var prefix in localNSMap){domBuilder.endPrefixMapping(prefix)}}endMatch||errorHandler.fatalError("end tag name: "+tagName+" is not match the current start tagName:"+config.tagName)}else{parseStack.push(config)}end++;break;case"?":locator&&position(tagStart),end=parseInstruction(source,tagStart,domBuilder);break;case"!":locator&&position(tagStart),end=parseDCC(source,tagStart,domBuilder,errorHandler);break;default:locator&&position(tagStart);var el=new ElementAttributes,currentNSMap=parseStack[parseStack.length-1].currentNSMap,len=(end=parseElementStartPart(source,tagStart,el,currentNSMap,entityReplacer,errorHandler),el.length);if(!el.closed&&fixSelfClosed(source,end,el.tagName,closeMap)&&(el.closed=!0,entityMap.nbsp||errorHandler.warning("unclosed xml attribute")),locator&&len){for(var locator2=copyLocator(locator,{}),i=0;i<len;i++){var a=el[i];position(a.offset),a.locator=copyLocator(locator,{})}domBuilder.locator=locator2,appendElementFromSax(el,domBuilder,currentNSMap)&&parseStack.push(el),domBuilder.locator=locator}else{appendElementFromSax(el,domBuilder,currentNSMap)&&parseStack.push(el)}"http://www.w3.org/1999/xhtml"!==el.uri||el.closed?end++:end=parseHtmlSpecialContent(source,end,el.tagName,entityReplacer,domBuilder)}}catch(e){errorHandler.error("element parse error: "+e),end=-1}end>start?start=end:appendText(Math.max(tagStart,start)+1)}}function copyLocator(f,t){return t.lineNumber=f.lineNumber,t.columnNumber=f.columnNumber,t}function parseElementStartPart(source,start,el,currentNSMap,entityReplacer,errorHandler){for(var attrName,p=++start,s=S_TAG;;){var c=source.charAt(p);switch(c){case"=":if(s===S_ATTR){attrName=source.slice(start,p),s=S_EQ}else{if(s!==S_ATTR_SPACE){throw new Error("attribute equal must after attrName")}s=S_EQ}break;case"'":case'"':if(s===S_EQ||s===S_ATTR){if(s===S_ATTR&&(errorHandler.warning('attribute value must after "="'),attrName=source.slice(start,p)),start=p+1,!((p=source.indexOf(c,start))>0)){throw new Error("attribute value no end '"+c+"' match")}value=source.slice(start,p).replace(/&#?\w+;/g,entityReplacer),el.add(attrName,value,start-1),s=S_ATTR_END}else{if(s!=S_ATTR_NOQUOT_VALUE){throw new Error('attribute value must after "="')}value=source.slice(start,p).replace(/&#?\w+;/g,entityReplacer),el.add(attrName,value,start),errorHandler.warning('attribute "'+attrName+'" missed start quot('+c+")!!"),start=p+1,s=S_ATTR_END}break;case"/":switch(s){case S_TAG:el.setTagName(source.slice(start,p));case S_ATTR_END:case S_TAG_SPACE:case S_TAG_CLOSE:s=S_TAG_CLOSE,el.closed=!0;case S_ATTR_NOQUOT_VALUE:case S_ATTR:case S_ATTR_SPACE:break;default:throw new Error("attribute invalid close char('/')")}break;case"":return errorHandler.error("unexpected end of input"),s==S_TAG&&el.setTagName(source.slice(start,p)),p;case">":switch(s){case S_TAG:el.setTagName(source.slice(start,p));case S_ATTR_END:case S_TAG_SPACE:case S_TAG_CLOSE:break;case S_ATTR_NOQUOT_VALUE:case S_ATTR:"/"===(value=source.slice(start,p)).slice(-1)&&(el.closed=!0,value=value.slice(0,-1));case S_ATTR_SPACE:s===S_ATTR_SPACE&&(value=attrName),s==S_ATTR_NOQUOT_VALUE?(errorHandler.warning('attribute "'+value+'" missed quot(")!!'),el.add(attrName,value.replace(/&#?\w+;/g,entityReplacer),start)):("http://www.w3.org/1999/xhtml"===currentNSMap[""]&&value.match(/^(?:disabled|checked|selected)$/i)||errorHandler.warning('attribute "'+value+'" missed value!! "'+value+'" instead!!'),el.add(value,value,start));break;case S_EQ:throw new Error("attribute value missed!!")}return p;case"Â€":c=" ";default:if(c<=" "){switch(s){case S_TAG:el.setTagName(source.slice(start,p)),s=S_TAG_SPACE;break;case S_ATTR:attrName=source.slice(start,p),s=S_ATTR_SPACE;break;case S_ATTR_NOQUOT_VALUE:var value=source.slice(start,p).replace(/&#?\w+;/g,entityReplacer);errorHandler.warning('attribute "'+value+'" missed quot(")!!'),el.add(attrName,value,start);case S_ATTR_END:s=S_TAG_SPACE}}else{switch(s){case S_ATTR_SPACE:el.tagName;"http://www.w3.org/1999/xhtml"===currentNSMap[""]&&attrName.match(/^(?:disabled|checked|selected)$/i)||errorHandler.warning('attribute "'+attrName+'" missed value!! "'+attrName+'" instead2!!'),el.add(attrName,attrName,start),start=p,s=S_ATTR;break;case S_ATTR_END:errorHandler.warning('attribute space is required"'+attrName+'"!!');case S_TAG_SPACE:s=S_ATTR,start=p;break;case S_EQ:s=S_ATTR_NOQUOT_VALUE,start=p;break;case S_TAG_CLOSE:throw new Error("elements closed character '/' and '>' must be connected to")}}}p++}}function appendElementFromSax(el,domBuilder,currentNSMap){for(var tagName=el.tagName,localNSMap=null,i=el.length;i--;){var a=el[i],qName=a.qName,value=a.value;if((nsp=qName.indexOf(":"))>0){var prefix=a.prefix=qName.slice(0,nsp),localName=qName.slice(nsp+1),nsPrefix="xmlns"===prefix&&localName}else{localName=qName,prefix=null,nsPrefix="xmlns"===qName&&""}a.localName=localName,!1!==nsPrefix&&(null==localNSMap&&(localNSMap={},_copy(currentNSMap,currentNSMap={})),currentNSMap[nsPrefix]=localNSMap[nsPrefix]=value,a.uri="http://www.w3.org/2000/xmlns/",domBuilder.startPrefixMapping(nsPrefix,value))}for(i=el.length;i--;){(prefix=(a=el[i]).prefix)&&("xml"===prefix&&(a.uri="http://www.w3.org/XML/1998/namespace"),"xmlns"!==prefix&&(a.uri=currentNSMap[prefix||""]))}var nsp;(nsp=tagName.indexOf(":"))>0?(prefix=el.prefix=tagName.slice(0,nsp),localName=el.localName=tagName.slice(nsp+1)):(prefix=null,localName=el.localName=tagName);var ns=el.uri=currentNSMap[prefix||""];if(domBuilder.startElement(ns,localName,tagName,el),!el.closed){return el.currentNSMap=currentNSMap,el.localNSMap=localNSMap,!0}if(domBuilder.endElement(ns,localName,tagName),localNSMap){for(prefix in localNSMap){domBuilder.endPrefixMapping(prefix)}}}function parseHtmlSpecialContent(source,elStartEnd,tagName,entityReplacer,domBuilder){if(/^(?:script|textarea)$/i.test(tagName)){var elEndStart=source.indexOf("</"+tagName+">",elStartEnd),text=source.substring(elStartEnd+1,elEndStart);if(/[&<]/.test(text)){return/^script$/i.test(tagName)?(domBuilder.characters(text,0,text.length),elEndStart):(text=text.replace(/&#?\w+;/g,entityReplacer),domBuilder.characters(text,0,text.length),elEndStart)
}}return elStartEnd+1}function fixSelfClosed(source,elStartEnd,tagName,closeMap){var pos=closeMap[tagName];return null==pos&&((pos=source.lastIndexOf("</"+tagName+">"))<elStartEnd&&(pos=source.lastIndexOf("</"+tagName)),closeMap[tagName]=pos),pos<elStartEnd}function _copy(source,target){for(var n in source){target[n]=source[n]}}function parseDCC(source,start,domBuilder,errorHandler){switch(source.charAt(start+2)){case"-":return"-"===source.charAt(start+3)?(end=source.indexOf("--\x3e",start+4))>start?(domBuilder.comment(source,start+4,end-start-4),end+3):(errorHandler.error("Unclosed comment"),-1):-1;default:if("CDATA["==source.substr(start+3,6)){var end=source.indexOf("]]>",start+9);return domBuilder.startCDATA(),domBuilder.characters(source,start+9,end-start-9),domBuilder.endCDATA(),end+3}var matchs=split(source,start),len=matchs.length;if(len>1&&/!doctype/i.test(matchs[0][0])){var name=matchs[1][0],pubid=len>3&&/^public$/i.test(matchs[2][0])&&matchs[3][0],sysid=len>4&&matchs[4][0],lastMatch=matchs[len-1];return domBuilder.startDTD(name,pubid&&pubid.replace(/^(['"])(.*?)\1$/,"$2"),sysid&&sysid.replace(/^(['"])(.*?)\1$/,"$2")),domBuilder.endDTD(),lastMatch.index+lastMatch[0].length}}return -1}function parseInstruction(source,start,domBuilder){var end=source.indexOf("?>",start);if(end){var match=source.substring(start,end).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/);if(match){match[0].length;return domBuilder.processingInstruction(match[1],match[2]),end+2}return -1}return -1}function ElementAttributes(source){}function split(source,start){var match,buf=[],reg=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;for(reg.lastIndex=start,reg.exec(source);match=reg.exec(source);){if(buf.push(match),match[1]){return buf}}}function copy(src,dest){for(var p in src){dest[p]=src[p]}}function _extends(Class,Super){var pt=Class.prototype;if(!(pt instanceof Super)){function t(){}t.prototype=Super.prototype,copy(pt,t=new t),Class.prototype=pt=t}pt.constructor!=Class&&("function"!=typeof Class&&console.error("unknow Class:"+Class),pt.constructor=Class)}XMLReader.prototype={parse:function(source,defaultNSMap,entityMap){var domBuilder=this.domBuilder;domBuilder.startDocument(),_copy(defaultNSMap,defaultNSMap={}),parse(source,defaultNSMap,entityMap,domBuilder,this.errorHandler),domBuilder.endDocument()}},ElementAttributes.prototype={setTagName:function(tagName){if(!tagNamePattern.test(tagName)){throw new Error("invalid tagName:"+tagName)}this.tagName=tagName},add:function(qName,value,offset){if(!tagNamePattern.test(qName)){throw new Error("invalid attribute:"+qName)}this[this.length++]={qName:qName,value:value,offset:offset}},length:0,getLocalName:function(i){return this[i].localName},getLocator:function(i){return this[i].locator},getQName:function(i){return this[i].qName},getURI:function(i){return this[i].uri},getValue:function(i){return this[i].value}},exports.XMLReader=XMLReader;var htmlns="http://www.w3.org/1999/xhtml",NodeType={},ELEMENT_NODE=NodeType.ELEMENT_NODE=1,ATTRIBUTE_NODE=NodeType.ATTRIBUTE_NODE=2,TEXT_NODE=NodeType.TEXT_NODE=3,CDATA_SECTION_NODE=NodeType.CDATA_SECTION_NODE=4,ENTITY_REFERENCE_NODE=NodeType.ENTITY_REFERENCE_NODE=5,ENTITY_NODE=NodeType.ENTITY_NODE=6,PROCESSING_INSTRUCTION_NODE=NodeType.PROCESSING_INSTRUCTION_NODE=7,COMMENT_NODE=NodeType.COMMENT_NODE=8,DOCUMENT_NODE=NodeType.DOCUMENT_NODE=9,DOCUMENT_TYPE_NODE=NodeType.DOCUMENT_TYPE_NODE=10,DOCUMENT_FRAGMENT_NODE=NodeType.DOCUMENT_FRAGMENT_NODE=11,NOTATION_NODE=NodeType.NOTATION_NODE=12,ExceptionCode={},ExceptionMessage={},INDEX_SIZE_ERR=ExceptionCode.INDEX_SIZE_ERR=(ExceptionMessage[1]="Index size error",1),DOMSTRING_SIZE_ERR=ExceptionCode.DOMSTRING_SIZE_ERR=(ExceptionMessage[2]="DOMString size error",2),HIERARCHY_REQUEST_ERR=ExceptionCode.HIERARCHY_REQUEST_ERR=(ExceptionMessage[3]="Hierarchy request error",3),WRONG_DOCUMENT_ERR=ExceptionCode.WRONG_DOCUMENT_ERR=(ExceptionMessage[4]="Wrong document",4),INVALID_CHARACTER_ERR=ExceptionCode.INVALID_CHARACTER_ERR=(ExceptionMessage[5]="Invalid character",5),NO_DATA_ALLOWED_ERR=ExceptionCode.NO_DATA_ALLOWED_ERR=(ExceptionMessage[6]="No data allowed",6),NO_MODIFICATION_ALLOWED_ERR=ExceptionCode.NO_MODIFICATION_ALLOWED_ERR=(ExceptionMessage[7]="No modification allowed",7),NOT_FOUND_ERR=ExceptionCode.NOT_FOUND_ERR=(ExceptionMessage[8]="Not found",8),NOT_SUPPORTED_ERR=ExceptionCode.NOT_SUPPORTED_ERR=(ExceptionMessage[9]="Not supported",9),INUSE_ATTRIBUTE_ERR=ExceptionCode.INUSE_ATTRIBUTE_ERR=(ExceptionMessage[10]="Attribute in use",10),INVALID_STATE_ERR=ExceptionCode.INVALID_STATE_ERR=(ExceptionMessage[11]="Invalid state",11),SYNTAX_ERR=ExceptionCode.SYNTAX_ERR=(ExceptionMessage[12]="Syntax error",12),INVALID_MODIFICATION_ERR=ExceptionCode.INVALID_MODIFICATION_ERR=(ExceptionMessage[13]="Invalid modification",13),NAMESPACE_ERR=ExceptionCode.NAMESPACE_ERR=(ExceptionMessage[14]="Invalid namespace",14),INVALID_ACCESS_ERR=ExceptionCode.INVALID_ACCESS_ERR=(ExceptionMessage[15]="Invalid access",15);function DOMException(code,message){if(message instanceof Error){var error=message}else{error=this,Error.call(this,ExceptionMessage[code]),this.message=ExceptionMessage[code],Error.captureStackTrace&&Error.captureStackTrace(this,DOMException)}return error.code=code,message&&(this.message=this.message+": "+message),error}function NodeList(){}function LiveNodeList(node,refresh){this._node=node,this._refresh=refresh,_updateLiveList(this)}function _updateLiveList(list){var inc=list._node._inc||list._node.ownerDocument._inc;if(list._inc!=inc){var ls=list._refresh(list._node);__set__(list,"length",ls.length),copy(ls,list),list._inc=inc}}function NamedNodeMap(){}function _findNodeIndex(list,node){for(var i=list.length;i--;){if(list[i]===node){return i}}}function _addNamedNode(el,list,newAttr,oldAttr){if(oldAttr?list[_findNodeIndex(list,oldAttr)]=newAttr:list[list.length++]=newAttr,el){newAttr.ownerElement=el;var doc=el.ownerDocument;doc&&(oldAttr&&_onRemoveAttribute(doc,el,oldAttr),_onAddAttribute(doc,el,newAttr))}}function _removeNamedNode(el,list,attr){var i=_findNodeIndex(list,attr);if(!(i>=0)){throw DOMException(NOT_FOUND_ERR,new Error(el.tagName+"@"+attr))}for(var lastIndex=list.length-1;i<lastIndex;){list[i]=list[++i]}if(list.length=lastIndex,el){var doc=el.ownerDocument;doc&&(_onRemoveAttribute(doc,el,attr),attr.ownerElement=null)}}function DOMImplementation(features){if(this._features={},features){for(var feature in features){this._features=features[feature]}}}function Node(){}function _xmlEncoder(c){return("<"==c?"&lt;":">"==c&&"&gt;")||"&"==c&&"&amp;"||'"'==c&&"&quot;"||"&#"+c.charCodeAt()+";"}function _visitNode(node,callback){if(callback(node)){return !0}if(node=node.firstChild){do{if(_visitNode(node,callback)){return !0}}while(node=node.nextSibling)}}function Document(){}function _onAddAttribute(doc,el,newAttr){doc&&doc._inc++,"http://www.w3.org/2000/xmlns/"==newAttr.namespaceURI&&(el._nsMap[newAttr.prefix?newAttr.localName:""]=newAttr.value)}function _onRemoveAttribute(doc,el,newAttr,remove){doc&&doc._inc++,"http://www.w3.org/2000/xmlns/"==newAttr.namespaceURI&&delete el._nsMap[newAttr.prefix?newAttr.localName:""]}function _onUpdateChild(doc,el,newChild){if(doc&&doc._inc){doc._inc++;var cs=el.childNodes;if(newChild){cs[cs.length++]=newChild}else{for(var child=el.firstChild,i=0;child;){cs[i++]=child,child=child.nextSibling}cs.length=i}}}function _removeChild(parentNode,child){var previous=child.previousSibling,next=child.nextSibling;return previous?previous.nextSibling=next:parentNode.firstChild=next,next?next.previousSibling=previous:parentNode.lastChild=previous,_onUpdateChild(parentNode.ownerDocument,parentNode),child}function _insertBefore(parentNode,newChild,nextChild){var cp=newChild.parentNode;if(cp&&cp.removeChild(newChild),newChild.nodeType===DOCUMENT_FRAGMENT_NODE){var newFirst=newChild.firstChild;if(null==newFirst){return newChild}var newLast=newChild.lastChild}else{newFirst=newLast=newChild}var pre=nextChild?nextChild.previousSibling:parentNode.lastChild;for(newFirst.previousSibling=pre,newLast.nextSibling=nextChild,pre?pre.nextSibling=newFirst:parentNode.firstChild=newFirst,null==nextChild?parentNode.lastChild=newLast:nextChild.previousSibling=newLast;newFirst.parentNode=parentNode,newFirst!==newLast&&(newFirst=newFirst.nextSibling);){}return _onUpdateChild(parentNode.ownerDocument||parentNode,parentNode),newChild.nodeType==DOCUMENT_FRAGMENT_NODE&&(newChild.firstChild=newChild.lastChild=null),newChild}function _appendSingleChild(parentNode,newChild){var cp=newChild.parentNode;if(cp){var pre=parentNode.lastChild;cp.removeChild(newChild);pre=parentNode.lastChild}pre=parentNode.lastChild;return newChild.parentNode=parentNode,newChild.previousSibling=pre,newChild.nextSibling=null,pre?pre.nextSibling=newChild:parentNode.firstChild=newChild,parentNode.lastChild=newChild,_onUpdateChild(parentNode.ownerDocument,parentNode,newChild),newChild}function Element(){this._nsMap={}}function Attr(){}function CharacterData(){}function Text(){}function Comment(){}function CDATASection(){}function DocumentType(){}function Notation(){}function Entity(){}function EntityReference(){}function DocumentFragment(){}function ProcessingInstruction(){}function XMLSerializer(){}function nodeSerializeToString(isHtml,nodeFilter){var buf=[],refNode=9==this.nodeType&&this.documentElement||this,prefix=refNode.prefix,uri=refNode.namespaceURI;if(uri&&null==prefix&&null==(prefix=refNode.lookupPrefix(uri))){var visibleNamespaces=[{namespace:uri,prefix:null}]}return serializeToString(this,buf,isHtml,nodeFilter,visibleNamespaces),buf.join("")}function needNamespaceDefine(node,isHTML,visibleNamespaces){var prefix=node.prefix||"",uri=node.namespaceURI;if(!prefix&&!uri){return !1}if("xml"===prefix&&"http://www.w3.org/XML/1998/namespace"===uri||"http://www.w3.org/2000/xmlns/"==uri){return !1}for(var i=visibleNamespaces.length;i--;){var ns=visibleNamespaces[i];if(ns.prefix==prefix){return ns.namespace!=uri}}return !0}function serializeToString(node,buf,isHTML,nodeFilter,visibleNamespaces){if(nodeFilter){if(!(node=nodeFilter(node))){return
}if("string"==typeof node){return void buf.push(node)}}switch(node.nodeType){case ELEMENT_NODE:visibleNamespaces||(visibleNamespaces=[]);visibleNamespaces.length;var attrs=node.attributes,len=attrs.length,child=node.firstChild,nodeName=node.tagName;isHTML=htmlns===node.namespaceURI||isHTML,buf.push("<",nodeName);for(var i=0;i<len;i++){"xmlns"==(attr=attrs.item(i)).prefix?visibleNamespaces.push({prefix:attr.localName,namespace:attr.value}):"xmlns"==attr.nodeName&&visibleNamespaces.push({prefix:"",namespace:attr.value})}for(i=0;i<len;i++){var attr;if(needNamespaceDefine(attr=attrs.item(i),isHTML,visibleNamespaces)){var prefix=attr.prefix||"",uri=attr.namespaceURI,ns=prefix?" xmlns:"+prefix:" xmlns";buf.push(ns,'="',uri,'"'),visibleNamespaces.push({prefix:prefix,namespace:uri})}serializeToString(attr,buf,isHTML,nodeFilter,visibleNamespaces)}if(needNamespaceDefine(node,isHTML,visibleNamespaces)){prefix=node.prefix||"",uri=node.namespaceURI,ns=prefix?" xmlns:"+prefix:" xmlns";buf.push(ns,'="',uri,'"'),visibleNamespaces.push({prefix:prefix,namespace:uri})}if(child||isHTML&&!/^(?:meta|link|img|br|hr|input)$/i.test(nodeName)){if(buf.push(">"),isHTML&&/^script$/i.test(nodeName)){for(;child;){child.data?buf.push(child.data):serializeToString(child,buf,isHTML,nodeFilter,visibleNamespaces),child=child.nextSibling}}else{for(;child;){serializeToString(child,buf,isHTML,nodeFilter,visibleNamespaces),child=child.nextSibling}}buf.push("</",nodeName,">")}else{buf.push("/>")}return;case DOCUMENT_NODE:case DOCUMENT_FRAGMENT_NODE:for(child=node.firstChild;child;){serializeToString(child,buf,isHTML,nodeFilter,visibleNamespaces),child=child.nextSibling}return;case ATTRIBUTE_NODE:return buf.push(" ",node.name,'="',node.value.replace(/[<&"]/g,_xmlEncoder),'"');case TEXT_NODE:return buf.push(node.data.replace(/[<&]/g,_xmlEncoder));case CDATA_SECTION_NODE:return buf.push("<![CDATA[",node.data,"]]>");case COMMENT_NODE:return buf.push("\x3c!--",node.data,"--\x3e");case DOCUMENT_TYPE_NODE:var pubid=node.publicId,sysid=node.systemId;if(buf.push("<!DOCTYPE ",node.name),pubid){buf.push(' PUBLIC "',pubid),sysid&&"."!=sysid&&buf.push('" "',sysid),buf.push('">')}else{if(sysid&&"."!=sysid){buf.push(' SYSTEM "',sysid,'">')}else{var sub=node.internalSubset;sub&&buf.push(" [",sub,"]"),buf.push(">")}}return;case PROCESSING_INSTRUCTION_NODE:return buf.push("<?",node.target," ",node.data,"?>");case ENTITY_REFERENCE_NODE:return buf.push("&",node.nodeName,";");default:buf.push("??",node.nodeName)}}function importNode(doc,node,deep){var node2;switch(node.nodeType){case ELEMENT_NODE:(node2=node.cloneNode(!1)).ownerDocument=doc;case DOCUMENT_FRAGMENT_NODE:break;case ATTRIBUTE_NODE:deep=!0}if(node2||(node2=node.cloneNode(!1)),node2.ownerDocument=doc,node2.parentNode=null,deep){for(var child=node.firstChild;child;){node2.appendChild(importNode(doc,child,deep)),child=child.nextSibling}}return node2}function cloneNode(doc,node,deep){var node2=new node.constructor;for(var n in node){var v=node[n];"object"!=typeof v&&v!=node2[n]&&(node2[n]=v)}switch(node.childNodes&&(node2.childNodes=new NodeList),node2.ownerDocument=doc,node2.nodeType){case ELEMENT_NODE:var attrs=node.attributes,attrs2=node2.attributes=new NamedNodeMap,len=attrs.length;attrs2._ownerElement=node2;for(var i=0;i<len;i++){node2.setAttributeNode(cloneNode(doc,attrs.item(i),!0))}break;case ATTRIBUTE_NODE:deep=!0}if(deep){for(var child=node.firstChild;child;){node2.appendChild(cloneNode(doc,child,deep)),child=child.nextSibling}}return node2}function __set__(object,key,value){object[key]=value}DOMException.prototype=Error.prototype,copy(ExceptionCode,DOMException),NodeList.prototype={length:0,item:function(index){return this[index]||null},toString:function(isHTML,nodeFilter){for(var buf=[],i=0;i<this.length;i++){serializeToString(this[i],buf,isHTML,nodeFilter)}return buf.join("")}},LiveNodeList.prototype.item=function(i){return _updateLiveList(this),this[i]},_extends(LiveNodeList,NodeList),NamedNodeMap.prototype={length:0,item:NodeList.prototype.item,getNamedItem:function(key){for(var i=this.length;i--;){var attr=this[i];if(attr.nodeName==key){return attr}}},setNamedItem:function(attr){var el=attr.ownerElement;if(el&&el!=this._ownerElement){throw new DOMException(INUSE_ATTRIBUTE_ERR)}var oldAttr=this.getNamedItem(attr.nodeName);return _addNamedNode(this._ownerElement,this,attr,oldAttr),oldAttr},setNamedItemNS:function(attr){var oldAttr,el=attr.ownerElement;if(el&&el!=this._ownerElement){throw new DOMException(INUSE_ATTRIBUTE_ERR)}return oldAttr=this.getNamedItemNS(attr.namespaceURI,attr.localName),_addNamedNode(this._ownerElement,this,attr,oldAttr),oldAttr},removeNamedItem:function(key){var attr=this.getNamedItem(key);return _removeNamedNode(this._ownerElement,this,attr),attr},removeNamedItemNS:function(namespaceURI,localName){var attr=this.getNamedItemNS(namespaceURI,localName);return _removeNamedNode(this._ownerElement,this,attr),attr},getNamedItemNS:function(namespaceURI,localName){for(var i=this.length;i--;){var node=this[i];if(node.localName==localName&&node.namespaceURI==namespaceURI){return node}}return null}},DOMImplementation.prototype={hasFeature:function(feature,version){var versions=this._features[feature.toLowerCase()];return !(!versions||version&&!(version in versions))},createDocument:function(namespaceURI,qualifiedName,doctype){var doc=new Document;if(doc.implementation=this,doc.childNodes=new NodeList,doc.doctype=doctype,doctype&&doc.appendChild(doctype),qualifiedName){var root=doc.createElementNS(namespaceURI,qualifiedName);doc.appendChild(root)}return doc},createDocumentType:function(qualifiedName,publicId,systemId){var node=new DocumentType;return node.name=qualifiedName,node.nodeName=qualifiedName,node.publicId=publicId,node.systemId=systemId,node}},Node.prototype={firstChild:null,lastChild:null,previousSibling:null,nextSibling:null,attributes:null,parentNode:null,childNodes:null,ownerDocument:null,nodeValue:null,namespaceURI:null,prefix:null,localName:null,insertBefore:function(newChild,refChild){return _insertBefore(this,newChild,refChild)},replaceChild:function(newChild,oldChild){this.insertBefore(newChild,oldChild),oldChild&&this.removeChild(oldChild)},removeChild:function(oldChild){return _removeChild(this,oldChild)},appendChild:function(newChild){return this.insertBefore(newChild,null)},hasChildNodes:function(){return null!=this.firstChild},cloneNode:function(deep){return cloneNode(this.ownerDocument||this,this,deep)},normalize:function(){for(var child=this.firstChild;child;){var next=child.nextSibling;next&&next.nodeType==TEXT_NODE&&child.nodeType==TEXT_NODE?(this.removeChild(next),child.appendData(next.data)):(child.normalize(),child=next)}},isSupported:function(feature,version){return this.ownerDocument.implementation.hasFeature(feature,version)},hasAttributes:function(){return this.attributes.length>0},lookupPrefix:function(namespaceURI){for(var el=this;el;){var map=el._nsMap;if(map){for(var n in map){if(map[n]==namespaceURI){return n}}}el=el.nodeType==ATTRIBUTE_NODE?el.ownerDocument:el.parentNode}return null},lookupNamespaceURI:function(prefix){for(var el=this;el;){var map=el._nsMap;if(map&&prefix in map){return map[prefix]}el=el.nodeType==ATTRIBUTE_NODE?el.ownerDocument:el.parentNode}return null},isDefaultNamespace:function(namespaceURI){return null==this.lookupPrefix(namespaceURI)}},copy(NodeType,Node),copy(NodeType,Node.prototype),Document.prototype={nodeName:"#document",nodeType:DOCUMENT_NODE,doctype:null,documentElement:null,_inc:1,insertBefore:function(newChild,refChild){if(newChild.nodeType==DOCUMENT_FRAGMENT_NODE){for(var child=newChild.firstChild;child;){var next=child.nextSibling;this.insertBefore(child,refChild),child=next}return newChild}return null==this.documentElement&&newChild.nodeType==ELEMENT_NODE&&(this.documentElement=newChild),_insertBefore(this,newChild,refChild),newChild.ownerDocument=this,newChild},removeChild:function(oldChild){return this.documentElement==oldChild&&(this.documentElement=null),_removeChild(this,oldChild)},importNode:function(importedNode,deep){return importNode(this,importedNode,deep)},getElementById:function(id){var rtv=null;return _visitNode(this.documentElement,function(node){if(node.nodeType==ELEMENT_NODE&&node.getAttribute("id")==id){return rtv=node,!0}}),rtv},createElement:function(tagName){var node=new Element;return node.ownerDocument=this,node.nodeName=tagName,node.tagName=tagName,node.childNodes=new NodeList,(node.attributes=new NamedNodeMap)._ownerElement=node,node},createDocumentFragment:function(){var node=new DocumentFragment;return node.ownerDocument=this,node.childNodes=new NodeList,node},createTextNode:function(data){var node=new Text;return node.ownerDocument=this,node.appendData(data),node},createComment:function(data){var node=new Comment;return node.ownerDocument=this,node.appendData(data),node},createCDATASection:function(data){var node=new CDATASection;return node.ownerDocument=this,node.appendData(data),node},createProcessingInstruction:function(target,data){var node=new ProcessingInstruction;return node.ownerDocument=this,node.tagName=node.target=target,node.nodeValue=node.data=data,node},createAttribute:function(name){var node=new Attr;return node.ownerDocument=this,node.name=name,node.nodeName=name,node.localName=name,node.specified=!0,node},createEntityReference:function(name){var node=new EntityReference;return node.ownerDocument=this,node.nodeName=name,node},createElementNS:function(namespaceURI,qualifiedName){var node=new Element,pl=qualifiedName.split(":"),attrs=node.attributes=new NamedNodeMap;return node.childNodes=new NodeList,node.ownerDocument=this,node.nodeName=qualifiedName,node.tagName=qualifiedName,node.namespaceURI=namespaceURI,2==pl.length?(node.prefix=pl[0],node.localName=pl[1]):node.localName=qualifiedName,attrs._ownerElement=node,node},createAttributeNS:function(namespaceURI,qualifiedName){var node=new Attr,pl=qualifiedName.split(":");return node.ownerDocument=this,node.nodeName=qualifiedName,node.name=qualifiedName,node.namespaceURI=namespaceURI,node.specified=!0,2==pl.length?(node.prefix=pl[0],node.localName=pl[1]):node.localName=qualifiedName,node
}},_extends(Document,Node),Element.prototype={nodeType:ELEMENT_NODE,hasAttribute:function(name){return null!=this.getAttributeNode(name)},getAttribute:function(name){var attr=this.getAttributeNode(name);return attr&&attr.value||""},getAttributeNode:function(name){return this.attributes.getNamedItem(name)},setAttribute:function(name,value){var attr=this.ownerDocument.createAttribute(name);attr.value=attr.nodeValue=""+value,this.setAttributeNode(attr)},removeAttribute:function(name){var attr=this.getAttributeNode(name);attr&&this.removeAttributeNode(attr)},appendChild:function(newChild){return newChild.nodeType===DOCUMENT_FRAGMENT_NODE?this.insertBefore(newChild,null):_appendSingleChild(this,newChild)},setAttributeNode:function(newAttr){return this.attributes.setNamedItem(newAttr)},setAttributeNodeNS:function(newAttr){return this.attributes.setNamedItemNS(newAttr)},removeAttributeNode:function(oldAttr){return this.attributes.removeNamedItem(oldAttr.nodeName)},removeAttributeNS:function(namespaceURI,localName){var old=this.getAttributeNodeNS(namespaceURI,localName);old&&this.removeAttributeNode(old)},hasAttributeNS:function(namespaceURI,localName){return null!=this.getAttributeNodeNS(namespaceURI,localName)},getAttributeNS:function(namespaceURI,localName){var attr=this.getAttributeNodeNS(namespaceURI,localName);return attr&&attr.value||""},setAttributeNS:function(namespaceURI,qualifiedName,value){var attr=this.ownerDocument.createAttributeNS(namespaceURI,qualifiedName);attr.value=attr.nodeValue=""+value,this.setAttributeNode(attr)},getAttributeNodeNS:function(namespaceURI,localName){return this.attributes.getNamedItemNS(namespaceURI,localName)},getElementsByTagName:function(tagName){return new LiveNodeList(this,function(base){var ls=[];return _visitNode(base,function(node){node===base||node.nodeType!=ELEMENT_NODE||"*"!==tagName&&node.tagName!=tagName||ls.push(node)}),ls})},getElementsByTagNameNS:function(namespaceURI,localName){return new LiveNodeList(this,function(base){var ls=[];return _visitNode(base,function(node){node===base||node.nodeType!==ELEMENT_NODE||"*"!==namespaceURI&&node.namespaceURI!==namespaceURI||"*"!==localName&&node.localName!=localName||ls.push(node)}),ls})}},Document.prototype.getElementsByTagName=Element.prototype.getElementsByTagName,Document.prototype.getElementsByTagNameNS=Element.prototype.getElementsByTagNameNS,_extends(Element,Node),Attr.prototype.nodeType=ATTRIBUTE_NODE,_extends(Attr,Node),CharacterData.prototype={data:"",substringData:function(offset,count){return this.data.substring(offset,offset+count)},appendData:function(text){text=this.data+text,this.nodeValue=this.data=text,this.length=text.length},insertData:function(offset,text){this.replaceData(offset,0,text)},appendChild:function(newChild){throw new Error(ExceptionMessage[HIERARCHY_REQUEST_ERR])},deleteData:function(offset,count){this.replaceData(offset,count,"")},replaceData:function(offset,count,text){text=this.data.substring(0,offset)+text+this.data.substring(offset+count),this.nodeValue=this.data=text,this.length=text.length}},_extends(CharacterData,Node),Text.prototype={nodeName:"#text",nodeType:TEXT_NODE,splitText:function(offset){var text=this.data,newText=text.substring(offset);text=text.substring(0,offset),this.data=this.nodeValue=text,this.length=text.length;var newNode=this.ownerDocument.createTextNode(newText);return this.parentNode&&this.parentNode.insertBefore(newNode,this.nextSibling),newNode}},_extends(Text,CharacterData),Comment.prototype={nodeName:"#comment",nodeType:COMMENT_NODE},_extends(Comment,CharacterData),CDATASection.prototype={nodeName:"#cdata-section",nodeType:CDATA_SECTION_NODE},_extends(CDATASection,CharacterData),DocumentType.prototype.nodeType=DOCUMENT_TYPE_NODE,_extends(DocumentType,Node),Notation.prototype.nodeType=NOTATION_NODE,_extends(Notation,Node),Entity.prototype.nodeType=ENTITY_NODE,_extends(Entity,Node),EntityReference.prototype.nodeType=ENTITY_REFERENCE_NODE,_extends(EntityReference,Node),DocumentFragment.prototype.nodeName="#document-fragment",DocumentFragment.prototype.nodeType=DOCUMENT_FRAGMENT_NODE,_extends(DocumentFragment,Node),ProcessingInstruction.prototype.nodeType=PROCESSING_INSTRUCTION_NODE,_extends(ProcessingInstruction,Node),XMLSerializer.prototype.serializeToString=function(node,isHtml,nodeFilter){return nodeSerializeToString.call(node,isHtml,nodeFilter)},Node.prototype.toString=nodeSerializeToString;try{if(Object.defineProperty){function getTextContent(node){switch(node.nodeType){case ELEMENT_NODE:case DOCUMENT_FRAGMENT_NODE:var buf=[];for(node=node.firstChild;node;){7!==node.nodeType&&8!==node.nodeType&&buf.push(getTextContent(node)),node=node.nextSibling}return buf.join("");default:return node.nodeValue}}Object.defineProperty(LiveNodeList.prototype,"length",{get:function(){return _updateLiveList(this),this.$$length}}),Object.defineProperty(Node.prototype,"textContent",{get:function(){return getTextContent(this)},set:function(data){switch(this.nodeType){case ELEMENT_NODE:case DOCUMENT_FRAGMENT_NODE:for(;this.firstChild;){this.removeChild(this.firstChild)}(data||String(data))&&this.appendChild(this.ownerDocument.createTextNode(data));break;default:this.data=data,this.value=data,this.nodeValue=data}}}),__set__=function(object,key,value){object["$$"+key]=value}}}catch(e){}function DOMParser(options){this.options=options||{locator:{}}}function buildErrorHandler(errorImpl,domBuilder,locator){if(!errorImpl){if(domBuilder instanceof DOMHandler){return domBuilder}errorImpl=domBuilder}var errorHandler={},isCallback=errorImpl instanceof Function;function build(key){var fn=errorImpl[key];!fn&&isCallback&&(fn=2==errorImpl.length?function(msg){errorImpl(key,msg)}:errorImpl),errorHandler[key]=fn&&function(msg){fn("[xmldom "+key+"]\t"+msg+_locator(locator))}||function(){}}return locator=locator||{},build("warning"),build("error"),build("fatalError"),errorHandler}function DOMHandler(){this.cdata=!1}function position(locator,node){node.lineNumber=locator.lineNumber,node.columnNumber=locator.columnNumber}function _locator(l){if(l){return"\n@"+(l.systemId||"")+"#[line:"+l.lineNumber+",col:"+l.columnNumber+"]"}}function _toString(chars,start,length){return"string"==typeof chars?chars.substr(start,length):chars.length>=start+length||start?new java.lang.String(chars,start,length)+"":chars}function appendElement(hander,node){hander.currentElement?hander.currentElement.appendChild(node):hander.doc.appendChild(node)}exports.DOMImplementation=DOMImplementation,exports.XMLSerializer=XMLSerializer,DOMParser.prototype.parseFromString=function(source,mimeType){var options=this.options,sax=new XMLReader,domBuilder=options.domBuilder||new DOMHandler,errorHandler=options.errorHandler,locator=options.locator,defaultNSMap=options.xmlns||{},isHTML=/\/x?html?$/.test(mimeType),entityMap=isHTML?htmlEntity.entityMap:{lt:"<",gt:">",amp:"&",quot:'"',apos:"'"};return locator&&domBuilder.setDocumentLocator(locator),sax.errorHandler=buildErrorHandler(errorHandler,domBuilder,locator),sax.domBuilder=options.domBuilder||domBuilder,isHTML&&(defaultNSMap[""]="http://www.w3.org/1999/xhtml"),defaultNSMap.xml=defaultNSMap.xml||"http://www.w3.org/XML/1998/namespace",source?sax.parse(source,defaultNSMap,entityMap):sax.errorHandler.error("invalid doc source"),domBuilder.doc},DOMHandler.prototype={startDocument:function(){this.doc=(new DOMImplementation).createDocument(null,null,null),this.locator&&(this.doc.documentURI=this.locator.systemId)},startElement:function(namespaceURI,localName,qName,attrs){var doc=this.doc,el=doc.createElementNS(namespaceURI,qName||localName),len=attrs.length;appendElement(this,el),this.currentElement=el,this.locator&&position(this.locator,el);for(var i=0;i<len;i++){namespaceURI=attrs.getURI(i);var value=attrs.getValue(i),attr=(qName=attrs.getQName(i),doc.createAttributeNS(namespaceURI,qName));this.locator&&position(attrs.getLocator(i),attr),attr.value=attr.nodeValue=value,el.setAttributeNode(attr)}},endElement:function(namespaceURI,localName,qName){var current=this.currentElement;current.tagName;this.currentElement=current.parentNode},startPrefixMapping:function(prefix,uri){},endPrefixMapping:function(prefix){},processingInstruction:function(target,data){var ins=this.doc.createProcessingInstruction(target,data);this.locator&&position(this.locator,ins),appendElement(this,ins)},ignorableWhitespace:function(ch,start,length){},characters:function(chars,start,length){if(chars=_toString.apply(this,arguments)){if(this.cdata){var charNode=this.doc.createCDATASection(chars)}else{charNode=this.doc.createTextNode(chars)}this.currentElement?this.currentElement.appendChild(charNode):/^\s*$/.test(chars)&&this.doc.appendChild(charNode),this.locator&&position(this.locator,charNode)}},skippedEntity:function(name){},endDocument:function(){this.doc.normalize()},setDocumentLocator:function(locator){(this.locator=locator)&&(locator.lineNumber=0)},comment:function(chars,start,length){chars=_toString.apply(this,arguments);var comm=this.doc.createComment(chars);this.locator&&position(this.locator,comm),appendElement(this,comm)},startCDATA:function(){this.cdata=!0},endCDATA:function(){this.cdata=!1},startDTD:function(name,publicId,systemId){var impl=this.doc.implementation;if(impl&&impl.createDocumentType){var dt=impl.createDocumentType(name,publicId,systemId);this.locator&&position(this.locator,dt),appendElement(this,dt)}},warning:function(error){console.warn("[xmldom warning]\t"+error,_locator(this.locator))},error:function(error){console.error("[xmldom error]\t"+error,_locator(this.locator))},fatalError:function(error){throw console.error("[xmldom fatalError]\t"+error,_locator(this.locator)),error}},"endDTD,startEntity,endEntity,attributeDecl,elementDecl,externalEntityDecl,internalEntityDecl,resolveEntity,getExternalSubset,notationDecl,unparsedEntityDecl".replace(/\w+/g,function(key){DOMHandler.prototype[key]=function(){return null}});module.exports={GS:GS,tool:tool,task:task,DOMParser:DOMParser};